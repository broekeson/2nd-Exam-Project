---
- name: Install ca-certificates, apt-transport-https and software-properties-common
  package:
    name: "{{ item }}" 
    state: latest
    with_items:
      - ca-certificates
      - apt-transport-https
      - software-properties-common

- name: Add GPG key for Debian/Ubuntu
  apt_key:
    url: https://packages.sury.org/php/apt.gpg
    state: present
  when: ansible_os_family == 'Debian'

- name: Add GPG key for CentOS
  rpm_key:
    key: https://packages.sury.org/php/apt.gpg
    state: present
  when: ansible_os_family == 'RedHat'

- name: Add sury repository for PHP on Debian/Ubuntu
  apt_repository:
    repo: deb https://packages.sury.org/php/ {{ ansible_distribution_release }} main
    state: present
  when: ansible_os_family == 'Debian'

- name: Add sury repository for PHP on CentOS
  yum_repository:
    name: sury
    description: Sury PHP packages
    baseurl: https://packages.sury.org/php/ {{ ansible_distribution_release }} main
    gpgcheck: yes
    gpgkey: https://packages.sury.org/php/apt.gpg
    state: present
  when: ansible_os_family == 'RedHat'

- name: Update for debian
  apt: update_cache=yes
  when: ansible_os_family == 'Debian'

- name: Update for centos
  yum: update_cache=yes
  when: ansible_os_family == 'RedHat'

- name: Install PHP and dependencies
  package:
    name: "{{ item }}" 
    state: present
  with_items:
    - php8.1
    - php8.1-mysql
    - php8.1-xml
    - php8.1-mbstring
    - php8.1-curl
    - php8.1-zip
    - libapache2-mod-php8.1
    - php8.1-common
    - php8.1-xmlrpc
    - php8.1-gd
    - php8.1-imagick
    - php8.1-cli
    - php8.1-dev
    - php8.1-imap
    - php8.1-mbstring
    - php8.1-opcache
    - php8.1-soap
    - php8.1-intl 

- include_tasks: db_setup.yml